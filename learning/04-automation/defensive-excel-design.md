# 防禦性 Excel 設計：處理非結構化人力維護資料

## 📌 背景
在 P-06 (業務獎金系統) 的開發中，原始資料是由多個部門人工維護的 Excel。這類資料具有高度的不確定性（多列佔位、拼寫錯誤、隨意插入行），傳統公式極易爆掉。

## 🛠️ 三大防禦策略

### 1. 結構化替代絕對引用
- **問題**：`VLOOKUP` 依賴欄位序號，一旦有人插入新欄位就會失效。
- **解法**：改用 **`XLOOKUP`** 或 **`INDEX MATCH`**。它們直接對應欄位名稱或整欄引用，欄位移動也不影響結果。
  ```excel
  =XLOOKUP(搜尋值, 姓名欄, 獎金欄, "未找到")
  ```

### 2. 繼承邏輯（解決「多列一筆」問題）
- **場景**：一筆資料佔兩列，但第二列只有介紹人名字。
- **技巧**：建立**隱藏輔助鍵 (Hidden Key)**。
  ```excel
  =IF(A2<>"", A2, E1)  // E1 是上一列的輔助鍵
  ```
  這讓每一列都能「找回自己的主人」，方便後續進行 `SUMIFS` 或 `COUNTIFS` 加總，且不影響主管要求的視覺外觀。

### 3. 表格化 (Ctrl + T) 與命名範圍
- **優點**：選中範圍後按 `Ctrl + T`，Excel 會將其轉為動態對象。新增資料時，公式會自動向下延伸，且公式的可讀性會從 `$A$2:$A$100` 變成 `[姓名]`。

## 💡 心法：邏輯解耦
- **分層存儲**：將「輸入層」、「規則層」、「運算層」與「結果輸出層」分開。
- **即便出錯也要優雅**：利用 `IFERROR` 提供友善的錯誤提示（例如：「請檢查案號」），而非冷冰冰的 `#N/A`。

---
> **總結**：好的 Excel 架構師會假設「使用者一定會亂填」，並在設計中預留容錯空間與自動校準邏輯。
