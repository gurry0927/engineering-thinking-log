# Odoo 資料架構與清洗策略 (Data Architecture & Strategy)

## 🏗️ 核心架構：三段式 Key 映射模型 (3-Tier Key Mapping)
為了解決資料清洗過程中「不可逆」與「可驗證性」的矛盾，設計了三層 ID 追蹤體系：

1. **原始資料 Key (Raw Data Key / Immutable ID)**
   - **性質**：絕對不變、不可刪除。
   - **定義**：代表歷史上曾存在過的「事實真相」，即使該筆資料是錯誤或重複的。
2. **公司實體 Key (Company Entity Key / Canonical ID)**
   - **性質**：唯一、乾淨、現行版本。
   - **定義**：洗完後歸納出的「真實實體」，所有相關的原始資料都必須反向綁定回此 Key。
3. **聯絡人實體 Key (Contact Entity Key / Canonical ID)**
   - **性質**：唯一、關聯至公司 Key。
   - **定義**：洗完後的正規化聯絡人。

> [!TIP]
> **Mapping Reason (對齊理由)**：每一筆綁定運算都附帶理由（如「統編一致」、「網域推論」），確保系統可以隨時進行審計與回溯。

---

## 🛠️ Odoo 導入策略：解耦投影模組 (Decoupled Projection Module)
為了解決 Odoo 原生資料庫設計不符合公司業務視角，且不破壞原生相容性的問題，設計了以下模式：

### 1. 尊重原生事實 (Native Fact Storage)
- 所有的資料仍然儲存在 Odoo 的原生欄位中。
- **優點**：確保所有 Odoo 原生應用（銷售、會計、CRM）都能正常存取資料，不破壞升級路徑。

### 2. 公司專屬擴充 (Custom Extensions)
- 將公司特有的需求欄位（如自定義標籤、特殊分類）放在自製模組中。

### 3. 視圖投影層 (The Projection Layer)
- **設計**：建立一個全新的模組（View），利用 Odoo 的繼承與 `related` 欄位將「原生欄位」+「擴充欄位」按照公司想看的邏輯重新排列。
- **定位**：這是一個 **Read Model (讀取模型)**。它不重複存儲資料，而是將分散在各處的事實「投影」成一個直觀的界面。

---

## 🛡️ 人類輸入緩衝層 (Human Input Buffer Pattern)
針對「電話分機亂寫」等混亂的人類行為，設計了 **雙欄位隔離模式**：

| 欄位類型 | 角色 | 儲存內容 |
| :--- | :--- | :--- |
| **Raw Input** | 證據層 | 使用者輸入的所有雜訊（02-xxx#111, *分機...） |
| **Normalized** | 機器層 | 經 Regex 清理後的標準格式 |

### UI 互動機制：
- **編輯模式**：切換至 **Raw Input** 欄位，允許使用者隨意紀錄。
- **顯示模式**：切換至 **Normalized** 欄位，呈現系統清洗後的乾淨觀點。
- **權限開關**：管理者可開啟切換鈕（Admin Toggle），直接看到原始資料以排除 Regex 洗不乾淨的問題。

---

## 💭 工程反思
- **資料真實性高於乾淨度**：不輕易刪除原始輸入，而是建立轉換函數（Projection/Regex）。
- **系統演化高於一次到位**：先接住資料，再逐步加強校驗（黃色警告 -> 紅色錯誤）。
