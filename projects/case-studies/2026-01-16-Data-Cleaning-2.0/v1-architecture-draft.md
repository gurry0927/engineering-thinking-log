# 客戶資料清洗 2.0 (初始架構草案 - 2026-01-16)

> [!NOTE]
> 這是 2026-01-16 專案啟動時的初始版本，紀錄了從 1.0 進化至 2.0 的核心需求、資料分析與 ID 架構設計。

## 專案概述
這是客戶資料清洗流程的 2.0 版本，目標是建立一套可重複使用的標準化流程。

---

## 對談紀錄與決策日誌

### 2026-01-16 - 專案啟動與需求確認

**背景：**
- 使用者有一份需要清洗的客戶資料 CSV（約 1772 筆）
- 資料夾中已有 v1.0 的部分處理腳本（step2~step5）
- 使用者預期會持續收到類似資料，需要建立可重複的流程

**使用者需求：**
1. **目標**：資料要進資料庫，但公司名稱太混亂
2. **核心問題**：同一家公司有 N 種不同寫法
3. **統一標準**：以政府登記資料為準
4. **保留關聯**：清洗後要能追溯原始資料（需要 ID 對應）

**資料問題分析（從原始 CSV 觀察）：**

| 問題類型 | 範例 |
|---------|------|
| 括號補充資訊 | `(旺群)長群建設股份有限公司`、`智昱永續管理顧問有限公司(冠呈)` |
| 股份簡寫不一 | `股份有限公司` vs `(股)` |
| 前後空白/Tab | `	豐滙建設開發股份有限公司`（前面有 Tab） |
| 尾部多餘字元 | `恆達空間智庫股份有限公司			`（後面多個 Tab） |
| 缺少法人後綴 | `僑駿建設`、`佳元建設`（應為股份有限公司？） |
| 建築師事務所格式 | `陳章安聯合建築師事務所-王淑敏`、`徐兆立+黃俊騰建築師事務所` |
| 集團關係標註 | `(元宏)形意生態聯合建築師事務所` |
| 純個人 | 可能存在，需識別 |

**使用者提出的設計想法：**
- 每筆資料編一個 ID
- 可追蹤「改名前是誰 → 改名後變誰」
- 方便未來自動入資料庫

---

## 待討論：ID 與對應機制設計

使用者的直覺是對的，ID 機制確實是好方案。以下是我的建議架構：

### 方案：三層 ID 架構

```
┌─────────────────────────────────────────────────────────┐
│  原始資料層 (raw_id)                                      │
│  - 每一筆原始 CSV 記錄一個唯一 ID                          │
│  - 範例：RAW-0001, RAW-0002...                           │
│  - 保留原始公司名稱，永不修改                              │
└─────────────────────────────────────────────────────────┘
                          ↓ 對應
┌─────────────────────────────────────────────────────────┐
│  標準公司層 (company_id)                                  │
│  - 每一家「真正的公司」一個 ID                             │
│  - 範例：COM-0001 = 長群建設股份有限公司                   │
│  - 儲存政府登記的正式名稱、統編等                          │
└─────────────────────────────────────────────────────────┘
                          ↓ 對應
┌─────────────────────────────────────────────────────────┐
│  實體層 (entity_id)                                       │
│  - 區分：公司 / 個人 / 不明                                │
│  - 個人：PER-0001                                         │
│  - 公司：直接用 company_id                                 │
└─────────────────────────────────────────────────────────┘
```

### 對應表設計

**mapping.csv** - 原始名稱 → 標準公司的對應
```
raw_id, original_name, company_id, entity_type, match_method
RAW-0001, (旺群)長群建設股份有限公司, COM-0032, company, manual
RAW-0002, 長群建設, COM-0032, company, fuzzy
RAW-0003, 王大明, null, person, rule
```

**companies.csv** - 標準公司主檔
```
company_id, official_name, tax_id, source
COM-0032, 長群建設股份有限公司, 12345678, 經濟部商工登記
```

---

## 決策紀錄

### 2026-01-16 - 四大問題決策

| 問題 | 決策 | 備註 |
|------|------|------|
| 個人的處理方式 | **標記為「個人」留著** | 不過濾，保留完整資料 |
| 查不到的公司 | **保留原名** | 標記為未驗證 |
| 統編查詢來源 | **使用者提供 API（主要）+ 台灣公司網爬蟲（備用）** | API 需要乾淨公司名才能查 |
| 人工審核 | **需要** | 模糊比對結果需人工確認 |

---

## 技術選擇

- **語言**：Python（延續 v1.0）
- **資料查詢**：
  1. **經濟部商工登記 API**（主要）- 已有可用版本
     - 公司登記 API: `6BBA2268-1367-4B42-9CCA-BC17499EBE8C`
     - 商業登記 API: `5F64D864-61CB-4D0D-8AD9-492047CC1EA6`
     - 限制：需要**精準匹配**公司名稱（`eq` 查詢）
  2. 台灣公司網爬蟲（備用）- 待開發
- **人工審核介面**：待設計（CSV 編輯 / Web UI / Excel）

### API 重要限制

政府 API 使用 **精準匹配**（`Company_Name eq 'xxx'`），這表示：
- `長群建設` ❌ 查不到
- `長群建設股份有限公司` ✅ 才能查到

**因此 Step 1 清洗必須把名稱「補完整」才能查 API。**

---

## Gemini 建議 vs 我們流程對照

| Gemini 建議 | 我們流程 | 狀態 |
|------------|---------|------|
| Step 1: 正規化（去空格、全半形、移除後綴） | Step 1 基礎清洗 | ✅ 已規劃，但需調整：**不能移除後綴，API 需要完整名稱** |
| Step 2: 特徵提取（括號、人名識別用 NLP） | Step 1 + Step 2 | ⚠️ NLP 可選用，但中文人名識別有難度 |
| Step 3: 模糊對應（FuzzyWuzzy / Levenshtein） | Step 5 人工審核前可加 | ✅ 值得採用，用於「查不到但可能有近似的」 |

### 採納 Gemini 建議的調整

1. **Step 1 調整**：
   - 原本：移除 `(股)`、`有限公司` 等後綴
   - 修正：**保留後綴**，甚至要「補上」缺少的後綴（如 `長群建設` → `長群建設股份有限公司`）

2. **新增 Step 3.5：模糊比對**
   - API 查不到時，用 FuzzyWuzzy 找相似公司名
   - 產出「建議匹配清單」給人工審核

3. **NLP 人名識別（可選）**：
   - 用 jieba / ckiptagger 識別人名
   - 但中文人名辨識不一定準，可先用規則（2-3 字、無組織關鍵字）

---

## ChatGPT PRD 建議評估

ChatGPT 提供了一份完整的 PRD，以下是有價值的觀點：

### 值得採納的設計

| 觀點 | 說明 | 我們的對應 |
|------|------|-----------|
| **company_key 概念** | 產生「去除法人後綴」的比對用 key，用於分群 | ✅ 非常有用！API 查詢用完整名稱，但分群比對用 key |
| **雙軌處理** | `company_clean`（完整清洗名）+ `company_key`（比對用） | ✅ 採納，解決 API 精準匹配 vs 模糊比對的矛盾 |
| **group_id 分群** | 不直接合併，先分群讓人確認 | ✅ 符合我們的人工審核流程 |
| **suggested_company_name** | 自動建議主公司名（最長 or 最完整） | ✅ 減少人工判斷負擔 |
| **review_status 欄位** | `待確認 / 已確認 / 拆分` | ✅ 人工審核流程需要 |
| **人名移除規則** | `-` 後方、括號內 2-3 字且無關鍵字 | ✅ 比 NLP 更實用的規則 |

### 與我們方案的差異

| ChatGPT 方案 | 我們方案 | 分析 |
|-------------|---------|------|
| 不查政府登記（第一階段） | 查政府登記 API | 我們更進一步，用統編驗證 |
| 無 ID 系統 | 三層 ID 架構 | 我們的 ID 系統對長期維護更好 |
| 僅分群不合併 | 分群 + 對應表 | 我們有 mapping.csv 做追溯 |

---

## 原始資料分析（2026-01-16）

### 統計數據

| 模式 | 數量 | 佔比 | 範例 |
|------|------|------|------|
| **含 `-` 分隔符** | 1381 | **78%** | `盛麗開發建設股份有限公司-曾盛勇` |
| 含 `()` 括號 | 104 | 6% | `(旺群)長群建設股份有限公司` |
| 含 `_` 底線 | 14 | <1% | `開務聯合建築師事務所_謝欣妤` |
| 含 `+` | 4 | <1% | `徐兆立+黃俊騰建築師事務所` |
| 含 `．` 全形點 | 2 | <1% | `賴浩平．趙英傑建築師事務所` |
| **總筆數** | 1771 | 100% | - |

### 結論：ChatGPT 規則有效性

**`-` 後方移除規則**：✅ **非常有效**
- 涵蓋 78% 的資料
- 絕大多數是「公司名-人名」格式
- 直接移除 `-` 後方即可

**`()` 括號處理**：⚠️ **需分類處理**

| 類型 | 範例 | 處理方式 |
|------|------|----------|
| 前綴集團標註 | `(旺群)長群建設` | 提取到獨立欄位，主名稱移除 |
| 後綴補充 | `智昱公司(冠呈)` | 提取到獨立欄位，主名稱移除 |
| 事務所主持人 | `大元建築師事務所(姚仁喜)` | 保留！這是事務所的正式名稱一部分 |
| 後綴備註 | `黃宗哲(工地)` | 移除 |
| 股份簡寫 | `台灣肥料(股)公司` | 展開為「股份有限公司」 |

### 特殊分隔符處理

| 符號 | 數量 | 情境 | 處理方式 |
|------|------|------|----------|
| `-` | 1381 | 公司-人名 | 後方移除 |
| `_` | 14 | 同上 | 後方移除 |
| `+` | 4 | 事務所聯名 | **保留**（正式名稱）|
| `．` | 2 | 事務所聯名 | **保留**（正式名稱）|
| `/` | 6 | 多公司/關係企業 | **特殊處理**（見下方）|

### `/` 斜線的特殊情況（6 筆）

這是最複雜的情況，代表「多家公司」或「關係企業」：

```
華業/薛昭信建築師事務所-陳毓美          → 事務所別名
鑫怡建設/鑫建築-魏銘萱                  → 公司+品牌
米羅生活科技開發有限公司/冠華營造股份有限公司  → 兩家獨立公司
宏匯思源/宏匯新北/宏匯瑞光股份有限公司-梁作帥  → 集團多公司
宏匯思源/宏匯新北/宏匯瑞光股份有限公司-邱宇斌  → 同上
吳明杰建築師事務所/禾磊建築              → 事務所+品牌
```

**建議處理方式：**

| 方案 | 說明 | 優點 | 缺點 |
|------|------|------|------|
| A. 拆分多筆 | 一筆原始 → 多筆清洗資料 | 每家公司獨立追蹤 | raw_id 不再 1:1 |
| B. 只取第一個 | `宏匯思源/宏匯新北/...` → `宏匯思源` | 簡單 | 丟失資訊 |
| C. 新增欄位 | `related_companies` 存放其他公司 | 保留完整資訊 | 欄位結構複雜 |

**我的建議**：採用 **方案 C**，新增 `related_companies` 欄位

```
raw_id: RAW-0001
company_raw: 宏匯思源/宏匯新北/宏匯瑞光股份有限公司-梁作帥
company_clean: 宏匯思源股份有限公司
related_companies: 宏匯新北股份有限公司, 宏匯瑞光股份有限公司
contact_name: 梁作帥
```

這樣：
- 主公司用於 API 查詢和分群
- 關聯公司資訊不丟失
- raw_id 維持 1:1 對應

---

### 建築師事務所的特殊格式

事務所常見「聯名」格式，這是**正式名稱**，不能拆：

| 格式 | 範例 | 說明 |
|------|------|------|
| A+B事務所 | `徐兆立+黃俊騰建築師事務所` | 兩位建築師合開 |
| A．B事務所 | `賴浩平．趙英傑建築師事務所` | 同上 |
| 事務所(主持人) | `大元建築師事務所(姚仁喜)` | 主持建築師標註 |

這些都是政府登記的正式名稱，查 API 時要**完整保留**。

---

## 資料來源分析（2026-01-16 更新）

### 兩種資料格式

**1. SSDC 客戶管理 CSV（主要）**
- 格式：單一 CSV，1771 筆
- 欄位：公司名稱, 姓名, 職稱, 電話, 手機, E-Mail, 地址, 傳真
- 特點：**公司名稱欄位已包含聯絡人**（如 `盛麗開發建設股份有限公司-曾盛勇`）

**2. 專案通訊錄 Excel（新增）**
- 格式：每個專案一個 xlsx 檔
- 欄位：公司名稱, 職稱, 姓名, E-Mail, 手機, 電話, 分機, 地址
- 特點：
  - 表頭包含專案資訊（案名、基地面積等）
  - 公司與聯絡人**分開欄位**
  - 同一公司可能有多位聯絡人（公司名稱欄位為空，向上合併）
  - **但也有部分資料仍是「公司-人名」格式**（如 `耀暟建設股份有限公司-邴祺城`）

### 專案通訊錄的結構特徵

```
Row 1: 公司名稱=京旺開發建設股份有限公司, 職稱=董事長, 姓名=張嘉群
Row 2: 公司名稱=null,                    職稱=開發部經理, 姓名=黃凱煌  ← 同公司
Row 3: 公司名稱=null,                    職稱=漢中段窗口, 姓名=黃威皜  ← 同公司
Row 4: 公司名稱=呂建勳建築師事務所        ← 新公司（只有公司名，無聯絡人）
Row 5: 公司名稱=瀚翔景觀,                職稱=經理, 姓名=江紋寬       ← 新公司
```

### 處理策略調整

| 資料來源 | 公司欄位特徵 | 處理方式 |
|---------|-------------|----------|
| CSV | 公司+人名混在一起 | 用 `-` `_` 分割 |
| Excel | 公司、人名分開 | 直接使用公司欄位 |
| Excel（部分）| 仍有「公司-人名」| 同 CSV 處理 |

### 統一處理流程

```
Step 0.1: 識別資料來源
  - CSV → 直接處理
  - Excel → 先解析表頭，找到資料起始行

Step 0.2: 標準化欄位
  - 統一輸出：raw_id, company_raw, contact_name, title, email, phone, ...

Step 0.3: 處理合併儲存格
  - Excel 中「公司名稱為空」的列，向上繼承公司名稱
```

---

### 採納後的欄位設計調整

**輸出欄位整合版：**
```
raw_id           # 原始記錄 ID（我們新增）
company_raw      # 原始公司名稱（不可修改）
company_clean    # 清洗後完整名稱（用於 API 查詢）
company_key      # 比對用 key（去除法人後綴）
entity_type      # 公司 / 事務所 / 個人 / 不明
group_id         # 分群 ID（疑似同公司）
suggested_name   # 建議的標準名稱
company_id       # 最終對應的標準公司 ID（我們新增）
tax_id           # 統一編號（我們新增，來自 API）
review_status    # 待確認 / 已確認 / 拆分
match_method     # auto / fuzzy / manual
```

---

## 流程設計（v2.2 完整自動化版）

### 設計目標

**「丟一包 CSV 進去，回來直接看結果」**

使用者可以丟入原始 CSV，執行一次 pipeline，系統自動完成清洗、分類、分群、查詢、關聯，最後產出完整報告。

### 完整流程圖

```
═══════════════════════════════════════════════════════════════════
                         Phase 1: 清洗與分類
═══════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────┐
│ Step 0: 匯入原始資料                                              │
│ - 讀取 CSV，每筆給 raw_id（永久 ID，不會變）                       │
│ - 輸出：step0_raw_data.csv                                        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: 基礎清洗                                                  │
│ - 去除前後空白/Tab、統一全形半形                                   │
│ - 異體字轉換（康熙部首→標準漢字）                                  │
│ - 提取括號內容、處理斜線（多公司）                                  │
│ - 輸出：step1_cleaned.csv                                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 1b: 深度清洗                                                 │
│ - 移除零寬字元、處理連字號/冒號/底線後的人名                        │
│ - 移除尾巴無意義數字和標點、不完整括號                              │
│ - 輸出：step1b_deep_cleaned.csv                                   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: 實體分類（使用姓名資料庫 v2.1）                            │
│ - 判斷：company / architect_office / person / government / ...   │
│ - 使用姓名資料庫精準判斷人名                                       │
│ - 輸出：step2_classified.csv                                      │
└─────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════
                       Phase 2: 分群與主檔建立
═══════════════════════════════════════════════════════════════════
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: 模糊比對分群                                              │
│ - 用 company_key 做模糊比對，找出「疑似同公司」的群組               │
│ - 相似度門檻 0.85（可調整）                                        │
│ - 輸出：step4_grouped.csv, group_id 欄位                          │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 6: 產出公司主檔                                              │
│ - 去重、產生 company_id                                           │
│ - 建立 raw_id → company_id 對應                                   │
│ - 輸出：companies.csv, mapping.csv                                │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 8: 標準名稱建議                                              │
│ - 每個群組選出「建議的標準名稱」（最完整/最長）                      │
│ - 輸出：companies.csv (suggested_name 欄位)                       │
└─────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════
                      Phase 3: 統一查詢（自動分流）
═══════════════════════════════════════════════════════════════════
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 13: 統一查詢流程（依 entity_type 分流）                       │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ company → 政府 API（主要）+ 台灣公司網（備援）            │     │
│  │           成功率 ~92%                                    │     │
│  └─────────────────────────────────────────────────────────┘     │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ architect_office → 政府採購網                            │     │
│  │                    成功率 ~43%                           │     │
│  └─────────────────────────────────────────────────────────┘     │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ government / person / unknown → 不查詢                   │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                   │
│ - 輸出：companies.csv（更新統編）、step13_review_list.csv          │
└─────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════
                      Phase 4: 關聯與最終輸出
═══════════════════════════════════════════════════════════════════
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 7: 公司關聯提取                                              │
│ - 處理括號內的關聯資訊（子公司、分公司、別名）                       │
│ - 輸出：company_relations.csv                                     │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│ Final: 產出最終結果                                               │
│ - companies.csv        ← 公司主檔（含統編、標準名稱）              │
│ - mapping.csv          ← raw_id → company_id 對應表              │
│ - contacts.csv         ← 聯絡人清單（含 company_id 關聯）          │
│ - review_list.csv      ← 人工審核清單                             │
│ - company_relations.csv ← 公司關聯表                              │
└─────────────────────────────────────────────────────────────────┘
```

### ID 對應機制（關鍵設計）

```
┌─────────────────────────────────────────────────────────────────┐
│  raw_id（原始記錄 ID）                                            │
│  - 每筆原始 CSV 資料一個永久 ID                                    │
│  - 格式：RAW-0001, RAW-0002...                                    │
│  - 永不修改，即使公司更名也不變                                     │
└─────────────────────────────────────────────────────────────────┘
                          ↓ 對應（mapping.csv）
┌─────────────────────────────────────────────────────────────────┐
│  company_id（公司 ID）                                            │
│  - 每家「真正的公司」一個 ID                                       │
│  - 格式：COM-0001, COM-0002...                                    │
│  - 多個 raw_id 可能對應同一個 company_id（同公司不同寫法）          │
│  - 公司更名 → company_id 不變，只更新 official_name               │
└─────────────────────────────────────────────────────────────────┘
                          ↓ 關聯
┌─────────────────────────────────────────────────────────────────┐
│  contact 聯絡人                                                   │
│  - 透過 raw_id 關聯到 company_id                                  │
│  - 公司更名後，聯絡人仍指向同一個 company_id                        │
│  - 查詢：SELECT * FROM contacts WHERE company_id = 'COM-0001'     │
└─────────────────────────────────────────────────────────────────┘
```

**關鍵問答：公司更名後，聯絡人還能找到嗎？**

✅ **可以！** 因為：
1. 聯絡人關聯的是 `company_id`，不是公司名稱
2. 公司更名只會更新 `companies.csv` 的 `official_name`
3. `company_id` 不變 → 聯絡人關聯不變

---

## 版本紀錄 (摘要)
- **v2.0.0 (2026-01-16)**: 專案初始化與 ID 架構提案。
- **v2.0.7 (2026-01-16)**: 新增異體字轉換（康熙部首→標準漢字）。
- **v2.1.0 (2026-01-16)**: 整合政府 API 與台灣公司網爬蟲。
- **v2.2.0 (2026-01-16)**: 完成三階段自動化 Pipeline 設計。
