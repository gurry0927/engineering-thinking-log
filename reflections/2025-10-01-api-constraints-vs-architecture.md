# 決策紀錄：架構順序調整——先下載後驗證的權宜之計

## 情境背景
- **專案**：LineBot 檔案搜集系統 (P-02)。
- **目標**：僅接收特定格式 (.xlsx, .docx) 且檔名正確的檔案。
- **技術瓶頸**：Line API 在事件觸發時不保證提供原始檔名。

## 我一開始的假設
- **假設 A**：API 應該像一般前端傳檔一樣，直接給我一個包含所有資訊的 JSON。
- **假設 B**：我應該在下載檔案「之前」就判斷是否要收，以節省頻寬。
> **當初為什麼這樣想？** 習慣了 Web 端開發的直覺，低估了通訊軟體 API 的封閉性與安全考量（分兩步：通知事件 -> 獲取內容）。

## 預見的風險 (Risk Assessment)
- **若不下載直接拒絕**：根本拿不到檔名可以判斷。
- **若下載後不清理**：Drive 會堆滿不合規的垃圾檔案。

## 驗證與實驗 (First-class Citizen)
- **API 測試**：發送測試檔案，觀察 Webhook Payload。確認 `fileName` 欄位並不總是可靠或存在。
- **流程重構**：
    1. **Step 1**: 盲收 (Blind Receive) 並暫存至 Drive。
    2. **Step 2**: 調用 DriveApp 讀取屬性。
    3. **Step 3**: 若不合規，立即觸發 `setTrashed(true)` 並回覆 User。

## 決策與行動
- **正式變更**：採用「**樂觀存檔，嚴格清理**」的異步驗證模式。
- **狀態管理**：引入過渡狀態碼 `5` (Pending Approval)，確保系統在處理中即便斷線也有紀錄可追蹤。

## 可遷移判斷 (Transferable Skill)
- **判斷原則**：**當技術接口 (API) 不提供直接資訊時，應利用受控的「中轉空間」(Mid-tier Storage) 來重建上下文環境**。

## 尚未解決的不確定性
- 高頻率的「建立後即刪除」是否會觸發 Google Drive 的流量異常偵測（雖然機率低）？
