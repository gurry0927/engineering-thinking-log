# [2025-10-01] 跨群組檔案搜集器：從需求到架構設計

## 今日目標
- [x] 設計 LineBot 跨群組檔案搜集系統架構 (P-02)。
- [x] 解決 LINE Messaging API 不直接提供下載檔名的技術限制。
- [x] 規劃檔案驗證、自動刪除與狀態管理流程 (Status Code: 5, 10, -1)。

## 學習與筆記
- **LINE API 陷阱**：接收檔案事件時，API 僅提供 `messageId` 與 `contentType`。必須下載存入 Drive 後，才能透過 `File.getName()` 取得檔名並進行規則檢查。
- **身分追蹤設計**：同時記錄 `userId` 與 `groupId` 是為了保留「私訊推播」與「群組公告」的擴充性。
- **防禦性清理**：不合規的檔案應直接從 Drive 刪除 (`setTrashed(true)`) 並在 Sheet 標註 `-1`，而非完全抹除紀錄，以供後續異議查詢。

## 遇到的挑戰與解決方案
- **問題**：如何在群組中精準推播回傳處理好的檔案給特定對象。
- **解決**：在 Sheet 中建立 `UserId` 與 `GroupId` 的 mapping。若使用者未加 Bot 好友，則僅能回傳至 `GroupId`；若已加好友，則保留 `UserId` 私訊的可能性。
- **問題**：不合規檔案堆積。
- **解決**：實作「自動刪除 + 狀態更新」機制，確保開發環境整潔且自動化告知使用者原因。

## 心態感悟
- 系統設計最有趣的地方在於「繞過限制」。當 API 不給檔名時，我們就換個順序（先存再驗），這就是工程師的解題思維。
- 專案開始具備「多環境（不同群組）」的規模感，這對我的架構觀是很好的磨練。

---

## 外部建議與提議 (AI Suggestions)
- [ ] 自動檢查 + 刪除的 GAS 範例程式（含 Drive 刪檔 + 更新 Sheet 狀態 + LINE 回覆）。
- [ ] 資料流架構示意圖 (Line -> GAS -> Drive/Sheet -> Push)。
